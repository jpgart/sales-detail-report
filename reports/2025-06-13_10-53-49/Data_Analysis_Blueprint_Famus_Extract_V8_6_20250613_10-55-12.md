# Data Analysis Blueprint: Famus Extract V8.6 Series

**Version:** 8.6 (Auto-generated by Python script)
**Date:** 2025-06-13 10:55:12
**Overall Objective:** To conduct a comprehensive analysis of sales data and deductions for grape shipments.
    1.  **Primary Output:** Detailed seasonal Excel reports with granular analyses for internal review, C-level data exploration, and exporter-specific insights. Each Excel file includes a "Sheet Descriptions" tab for clarity and features enhanced formatting (e.g., headers at row 1, bolding, adjusted column widths, freeze panes).
    2.  **Secondary Output:** Corresponding seasonal CSV files for each table generated in the Excel reports, stored in season-specific subdirectories.
    3.  **Integrated Output:** This Markdown blueprint, auto-generated with each run of the script to ensure documentation stays synchronized with the code.
    4.  **Integrated Output:** A Quality Control summary printed to the console upon completion of data processing and report generation for each season.

## 1. Data Sources

* **Primary Data:** Main sales and deductions data file (e.g., `JP Famus Report Original 05.15.25 - FAMOUS LOT DETAIL REPORT SA GRAPES 24-25.csv`).
* **Supporting Information (Embedded within the Python script):**
    * `EXPORTER_MAPPINGS`: Dictionary for correcting exporter name misspellings and mapping common tags.
    * `SPECIFIC_LOTID_EXPORTER_MAP`: Dictionary for `lotid`-to-exporter overrides.
    * `EXPORTER_COUNTRY_MAP`: Dictionary mapping cleaned exporter names to their countries.
    * `GRAPE_VARIETIES_LIST_FROM_USER` & `VARIETY_NORMALIZATION_MAP`: For standardizing grape variety names.
    * `PACKAGING_DETAIL_PATTERNS` & `PACKAGING_STYLE_KEYWORDS`: For extracting packaging information.
    * `AGROLATINA_SPECIFIC_CHARGES`: List of charges for specific analysis for Agrolatina.
    * Season Definitions:
        * "2023-2024": November 1, 2023 - November 30, 2024 (inclusive).
        * "2024-2025": December 1, 2024 - November 30, 2025 (inclusive).

## 2. Data Cleaning and Preprocessing Plan

* **Initial Load & Basic Cleaning:** Load data, convert date columns, clean and convert numeric columns (`pricepercase` to `pricepercase_cleaned`; `invcicqnt`, `rcptqnt`, `saleamt`, `chgamt`, `chgqnt`), handling NaNs.
* **Exporter Standardization:** Create `Exporter_Clean` column.
* **Country Mapping:** Create `Exporter_Country` column.
* **Variety Extraction:** Create `Variety` column.
* **Packaging Extraction:** Create `Packaging_Style` and `Packaging_Detail` columns from `gwrproductdescr` (for rows with `pricepercase` data).
* **Retailer Name Extraction:** Create `Retailer_Name` from `descr` for sales transactions (`trxtype == 1`, `invcicqnt != 0`).

## 3. Feature Engineering

* **`Season` Column:** Derived from `refdate`.
* **Commission & Advance Flags:** `Is_Advance`, `Is_ProducePay_Commission`, `Is_Retailer_Commission`.
* **Price Per Case Metrics:** `Price_Per_Case_invc` (`saleamt / invcicqnt`), `Price_Per_Case_rcpt` (`saleamt / rcptqnt`).
* **Readable Column Names:** A utility function (`rename_columns_for_readability`) is applied to all DataFrames before output to convert underscore_case or camelCase to "Title Case With Spaces".

## 4. Analysis Plan (Results generated per Season)

* **Lot Financial Summary (`calculate_lot_summary_with_exporter`):** Per-lot and exporter: Total Sales, Deductions (Excl. Advances), Advances, FOB Price, Advance % of FOB.
* **Pivoted Deductions (`analyze_deductions_by_category_per_lot`):** `lotid` & `Exporter_Clean` vs. `chargedescr` (sum of `chgamt`, excl. advances).
* **Deduction Exporter View (`analyze_deductions_exporter_view`):** Detailed deductions per `lotid`, `Exporter_Clean`, `chargedescr`, with `Total_Cases_Sold_Lot` and `Avg_Deduction_Per_Case`.
* **Ocean Freight:**
    * `get_detailed_ocean_freight_data`: Granular table.
    * `analyze_ocean_freight_summary_by_country`: Chile vs. Peru average comparison.
* **Retailer Sales by Exporter (`analyze_retailer_sales_by_exporter`):** Per exporter: summary by `Retailer_Name` (Total Cases, Sales, Avg Price). Includes "Exporter Clean" column.
* **Charges by Lot per Exporter (`analyze_charges_by_lot_per_exporter`):** Per exporter: pivot of all charges (`trxtype==2`) by `lotid` vs. `chargedescr`, with row/column totals. Includes "Exporter Clean" column.
* **Deduction Consistency (`analyze_deduction_consistency_by_charge`):** Per `chargedescr`: stats of `Avg_Deduction_Per_Case` across all relevant exporters for the season. All exporters for the season are listed.
* **Retailer Performance Detailed (`analyze_retailer_performance_detailed`):**
    # * `Retailer_Perf_Season`: (Eliminado)
    # * `Retailer_Perf_AllTime`: (Eliminado)
* **Odd Retailers (`analyze_odd_retailers`):** Sales with `invcicqnt != 0` but `saleamt` is zero/NaN.
* **Charge Characteristics:**
    * `analyze_fixed_vs_variable_charges`: Identifies charges often occurring without `chgqnt`.
    * `analyze_charge_rate_consistency`: Analyzes `chgamt/chgqnt` rates.
* **Fumigation Charges (`analyze_fumigation_charges`):** Checks application to non-Chilean exporters.
* **Commissions Overview (`analyze_commissions_overview`):** Summary of commission types.
* **Agrolatina Specific Charges (`analyze_agrolatina_specific_charges`):** Pivot table for predefined Agrolatina charges.
* **Data Quality Reporting (CSV/Excel Sheets):**
    * `DQ_Unknown_Exp`: Lots with "Unknown Exporter".
    * `DQ_Deduc_NoSales`: Lots with deductions but no sales.

## 5. Outputs (per Season)

### 5.1. Excel Reports
* **Filename:** `sales_analysis_report_[SeasonName].xlsx`.
* **First Sheet ("Sheet_Descriptions"):** Table of Contents listing all subsequent sheets and their detailed explanations (from `SHEET_DESCRIPTIONS` dictionary).
* **Data Sheets:** Headers start at Row 1. Includes tables for all analyses listed in section 4.
* **Formatting:** Headers are bold, centered, wrapped. Column widths adjusted (TOC Col A wider, data cols default/capped). Top row & first column frozen.

### 5.2. CSV Reports
* Stored in season-specific subdirectories (e.g., `CSV_Report_2023-2024/`).
* One CSV file per table generated in the Excel report.
* Filenames mirror Excel sheet names (e.g., `Deduc_Summary.csv`).
* Contain raw numeric data with readable column headers.

## 6. Quality Control Module (`run_quality_control_checks`)
* Executed after data processing and report generation for each season.
* Reads selected generated CSV files (or uses in-memory DataFrames) to perform validation checks.
* **Example Checks:**
    * **Totals Consistency:** Compares aggregated totals (e.g., total sales from 'Lot_Financial_Sum_All') against the sum of per-exporter totals (e.g., from 'LotFinancialSum_Exp_{ExporterName}' sheets) for key metrics like 'Total Sales', 'Total Cases Sold Invc'.
    * **Null Value Checks:** Verifies that critical identifier columns (e.g., 'Lotid', 'Exporter Clean', 'Retailer Name' in relevant tables) and key financial columns in summary tables do not contain unexpected nulls.
    * **Duplicate Checks:** Ensures no unintended duplicates for primary key combinations (e.g., 'Lotid' + 'Exporter Clean' should be unique in 'Lot_Financial_Sum_All').
    * **Formula Validation (Spot Checks):** Re-calculates key metrics like 'FOB Price' or 'Avg Deduction Per Case' for a sample of rows from relevant tables to ensure formulas are applied correctly.
    * **Logical Checks:**
        * Verifies that 'Total Advances' in 'Lot_Financial_Sum_All' are not negative.
        * Checks if 'Fumigation_Analysis' correctly identifies only Chilean exporters for fumigation charges (or flags discrepancies).
    * **Cross-Table Reconciliation (Example):** Verifies that the sum of 'Total Cases Sold Lot' from 'Deduc_Summary' for a given lot matches the 'Total Cases Sold Invc' for that lot in sales-related tables where appropriate.
* **Output:** Prints a summary of QC checks (pass/fail/warning) to the console for each season.

## 7. Future (To be handled by separate scripts or later versions)
* C-Level HTML Executive Summary Report.
* Interactive HTML Dashboards.
* Personalized PDF/HTML reports for individual exporters.
